<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#031207" />
<link rel="manifest" href="./manifest.webmanifest" />
<title>FO76 Tracker</title>
<link rel="stylesheet" href="./style-186.css" />
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<div id="root"></div>

<!-- OCR overlay -->
<div class="overlay" id="ocrOverlay" tabindex="-1">
  <div class="box">
    <h4>Importing‚Ä¶</h4>
    <p id="ocrStatus">Initializing‚Ä¶</p>
    <p style="font-size:12px;margin:6px 0 0"><b>Tip:</b> first run may fetch OCR files (one-time). On a good connection this takes ~5‚Äì25s; later imports usually take ~2‚Äì6s.</p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button class="btn" id="ocrRetry" style="display:none">Try again</button>
      <button class="btn" id="ocrCancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Review overlay -->
<div class="overlay" id="reviewOverlay">
  <div class="box">
    <h4>Review &amp; Import</h4>
    <div id="reviewBody" style="max-height:50vh;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px;background:var(--panel2)"></div>
    <div id="reviewHint" style="font-size:12px;color:var(--muted);margin-top:6px">Auto-selected lines are what the parser thinks are challenges. Adjust as you like.</div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap">
      <button class="btn" id="reviewSelectAll">Select all</button>
      <button class="btn" id="reviewSelectNone">Select none</button>
      <button class="btn" id="reviewCopy">Copy text</button>
      <span style="flex:1"></span>
      <button class="btn" id="reviewImportDaily">Import to Daily</button>
      <button class="btn" id="reviewImportWeekly">Import to Weekly</button>
      <button class="btn" id="reviewClose">Close</button>
    </div>
  </div>
</div>

<!-- Theme overlay -->
<div class="overlay" id="themeOverlay">
  <div class="box" style="text-align:center;max-width:380px">
    <h4>Theme</h4>
    <svg id="wheel" viewBox="0 0 200 200" width="240" height="240" style="display:block;margin:0 auto">
      <defs><filter id="soft" x="-20%" y="-20%" width="140%"><feGaussianBlur in="SourceGraphic" stdDeviation="0.6"/></filter></defs>
      <circle cx="100" cy="100" r="96" fill="rgba(0,0,0,0.35)" stroke="var(--border)" stroke-width="2"></circle>
    </svg>
    <div class="theme-footer"><button class="btn" id="themeClose">Close</button></div>
  </div>
</div>

<!-- Info overlay (Install lives here) -->
<div class="overlay" id="infoOverlay">
  <div class="box">
    <h3 style="margin:0 0 8px">FO76 Tracker ‚Äî Quick guide</h3>
    <ul style="margin:8px 0 0 18px;line-height:1.5">
      <li><b>Theme</b>: pick any color slice.</li>
      <li><b>All / Daily / Weekly</b>: ‚ÄúAll‚Äù shows both panels. <i>Adding/removing is in the individual tabs to keep All clean.</i></li>
      <li><b>Import image</b>: upload a screenshot; the app OCRs it and lets you review lines before importing.</li>
      <li><b>OCR</b> = <i>Optical Character Recognition</i> ‚Äî turns text in your screenshot into editable text here.</li>
      <li><b>Hide completed</b>: hides checked items; auto-resets daily at noon ET, weekly on Tue noon ET.</li>
      <li><b>Gold</b> & <b>Caps</b>: quick checkboxes for currency routines; timers warn near reset.</li>
      <li><b>Install on your phone</b>: <button class="btn" id="installFromInfo">Install</button> (Android/Chrome). If this doesn‚Äôt open a prompt, use your browser menu ‚Üí ‚ÄúInstall app‚Äù.</li>
      <li><b>Auto-update</b>: checks on load and every 30min; shows a reload toast when a new version is ready.</li>
    </ul>
    <div style="text-align:right;margin-top:12px"><button class="btn" id="infoClose">Close</button></div>
  </div>
</div>

<!-- Footer with version + refresh -->
<div class="footer">
  <div class="bar">
    <span id="verSlot">FO76 Tracker v1.8.0</span>
    <button class="icon" id="refreshBtn" title="Check for updates / reload">‚ü≥</button>
  </div>
</div>

<script>
var VERSION = "1.8.0";

/* ===== Theme system ===== */
var THEMES = {
  green:{ color:'#4cff5a', tokens:{ '--bg':'#031207','--bg1':'#05160b','--bg2':'#072313','--panel':'rgba(3,18,9,.9)','--panel2':'#04150a','--border':'#0b3a1d','--text':'#c7ffb0','--muted':'#7acb79','--acc':'#4cff5a','--acc2':'#6dff84','--glow':'rgba(76,255,90,.25)','--plate-off':'#1b2a1f','--plate-on':'#0b1510','--plate-ink':'#f1f7f2' } },
  blue: { color:'#4cbcff', tokens:{ '--bg':'#07121f','--bg1':'#0c1a2e','--bg2':'#102541','--panel':'rgba(8,20,35,.9)','--panel2':'#0a1729','--border':'#113154','--text':'#c7e9ff','--muted':'#7ab1cb','--acc':'#4cbcff','--acc2':'#78d4ff','--glow':'rgba(76,188,255,.25)','--plate-off':'#1a2634','--plate-on':'#0a121a','--plate-ink':'#eef5fa' } },
  red:  { color:'#ff4c4c', tokens:{ '--bg':'#1f0a0a','--bg1':'#2a0f0f','--bg2':'#3b1414','--panel':'rgba(35,8,8,.9)','--panel2':'#1f0d0d','--border':'#4a1b1b','--text':'#ffc7c7','--muted':'#cb7a7a','--acc':'#ff4c4c','--acc2':'#ff7a7a','--glow':'rgba(255,76,76,.25)','--plate-off':'#2a1515','--plate-on':'#120808','--plate-ink':'#fff2f2' } },
  violet:{ color:'#b84cff', tokens:{ '--bg':'#130a1f','--bg1':'#1b0f2a','--bg2':'#27143b','--panel':'rgba(26,8,35,.9)','--panel2':'#1a0d29','--border':'#2d1b4a','--text':'#e1c7ff','--muted':'#b07acb','--acc':'#b84cff','--acc2':'#d178ff','--glow':'rgba(184,76,255,.25)','--plate-off':'#241a2f','--plate-on':'#120a19','--plate-ink':'#f6f0ff' } },
  mono: { color:'#dfdfdf', tokens:{ '--bg':'#0d0d0d','--bg1':'#121212','--bg2':'#1a1a1a','--panel':'rgba(20,20,20,.9)','--panel2':'#141414','--border':'#2a2a2a','--text':'#dfdfdf','--muted':'#aaa','--acc':'#e0e0e0','--acc2':'#fff','--glow':'rgba(255,255,255,.18)','--plate-off':'#2a2a2a','--plate-on':'#141414','--plate-ink':'#f6f6f6' } },
  amber:{ color:'#ffb84c', tokens:{ '--bg':'#1b1205','--bg1':'#201606','--bg2':'#2a1d08','--panel':'rgba(34,22,8,.92)','--panel2':'#1c1307','--border':'#3a2a0e','--text':'#ffe9c2','--muted':'#d7b37a','--acc':'#ffb84c','--acc2':'#ffd78a','--glow':'rgba(255,184,76,.25)','--plate-off':'#2b1f0f','--plate-on':'#1a1309','--plate-ink':'#fff7ea' } },
  teal: { color:'#39d3c6', tokens:{ '--bg':'#071c1a','--bg1':'#0a2321','--bg2':'#0e2f2c','--panel':'rgba(8,30,29,.9)','--panel2':'#0a2523','--border':'#114743','--text':'#c7fff7','--muted':'#7ad3cb','--acc':'#39d3c6','--acc2':'#7ff3e8','--glow':'rgba(57,211,198,.25)','--plate-off':'#1a2b29','--plate-on':'#0a1413','--plate-ink':'#eafffb' } }
};
function applyTheme(name){
  var t = THEMES[name]||THEMES.green;
  var r = document.documentElement;
  Object.keys(t.tokens).forEach(function(k){ r.style.setProperty(k, t.tokens[k]); });
  localStorage.setItem('fo76-theme',name);
}
function openTheme(){ document.getElementById('themeOverlay').classList.add('show') }
function closeTheme(){ document.getElementById('themeOverlay').classList.remove('show') }
function drawWheel(){
  var svg=document.getElementById('wheel');
  Array.from(svg.querySelectorAll('path,circle.slice')).forEach(function(n){n.remove()});
  var keys=Object.keys(THEMES),cx=100,cy=100,r=90,stroke="rgba(0,0,0,0.0001)",step=(2*Math.PI)/keys.length;
  keys.forEach(function(k,i){
    var a0=-Math.PI/2+i*step, a1=-Math.PI/2+(i+1)*step+0.0001;
    var x0=cx+r*Math.cos(a0), y0=cy+r*Math.sin(a0), x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1), large=(a1-a0)>Math.PI?1:0;
    var p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',"M "+cx+" "+cy+" L "+x0+" "+y0+" A "+r+" "+r+" 0 "+large+" 1 "+x1+" "+y1+" Z");
    p.setAttribute('fill',THEMES[k].color); p.setAttribute('stroke',stroke); p.setAttribute('stroke-width','1'); p.setAttribute('filter','url(#soft)'); p.style.cursor='pointer';
    p.addEventListener('click',function(){applyTheme(k); closeTheme();}); svg.appendChild(p);
  });
  var cap=document.createElementNS('http://www.w3.org/2000/svg','circle'); cap.setAttribute('class','slice'); cap.setAttribute('cx',100); cap.setAttribute('cy',100); cap.setAttribute('r',24);
  cap.setAttribute('fill','var(--panel2)'); cap.setAttribute('stroke','var(--border)'); cap.setAttribute('stroke-width','2'); svg.appendChild(cap);
}

/* ===== Install (Info-only) ===== */
var deferredPrompt = null;
window.addEventListener('beforeinstallprompt', function(e){ e.preventDefault(); deferredPrompt = e; });
async function tryPromptInstall(){
  if(!deferredPrompt){ alert('If no prompt appears, use your browser menu ‚Üí "Install app".'); return; }
  deferredPrompt.prompt();
  var choice = await deferredPrompt.userChoice; deferredPrompt=null;
  if(choice && choice.outcome==='accepted') alert('Installed ‚Äî find FO76 on your Home screen');
}
function setupInstallFromInfo(){ var btn=document.getElementById('installFromInfo'); if(btn) btn.addEventListener('click', tryPromptInstall); }

/* ===== Auto-update + footer refresh ===== */
function setupAutoUpdateUI() {
  var style = document.createElement('style');
  style.textContent = '.update-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;display:flex;gap:10px;align-items:center;z-index:9999;background:var(--panel);border:1px solid var(--border);box-shadow:var(--shadow);color:var(--text);padding:10px 14px;border-radius:12px}.update-toast button{border:1px solid var(--border);background:var(--panel2);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}';
  document.head.appendChild(style);
}
function showUpdateToast(){
  if(document.querySelector('.update-toast')) return;
  var t=document.createElement('div'); t.className='update-toast'; t.innerHTML='<span>New version available</span>';
  var b=document.createElement('button'); b.textContent='Reload';
  b.onclick=async function(){ var reg=await navigator.serviceWorker.getRegistration(); if(reg && reg.waiting) reg.waiting.postMessage('SKIP_WAITING'); else location.reload(); };
  t.appendChild(b); document.body.appendChild(t);
}
function setupAutoUpdate(){
  if(!('serviceWorker' in navigator)) return;
  var refreshing=false;
  navigator.serviceWorker.addEventListener('controllerchange',function(){ if(refreshing) return; refreshing=true; window.location.reload(); });
  navigator.serviceWorker.getRegistration().then(function(reg){
    if(!reg) return;
    reg.update();
    setInterval(function(){reg.update()}, 30*60*1000);
    reg.addEventListener('updatefound',function(){
      var sw=reg.installing; if(!sw) return;
      sw.addEventListener('statechange',function(){ if(sw.state==='installed' && navigator.serviceWorker.controller) showUpdateToast(); });
    });
  });
}
async function manualRefresh(){
  var reg = await navigator.serviceWorker.getRegistration();
  if(reg){ await reg.update(); if(reg.waiting){ reg.waiting.postMessage('SKIP_WAITING'); return; } }
  location.href = location.pathname + '?r=' + Date.now();
}
function setupFooter(){
  var btn=document.getElementById('refreshBtn'); if(btn) btn.addEventListener('click', manualRefresh);
  var slot=document.getElementById('verSlot'); if(slot) slot.textContent = 'FO76 Tracker v'+VERSION;
}

/* ===== OCR helpers & Review drawer ===== */
var OCR_MIRRORS = {
  worker:['https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js','https://unpkg.com/tesseract.js@5/dist/worker.min.js','https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.3/worker.min.js'],
  core:['https://cdn.jsdelivr.net/npm/tesseract.js-core@5.0.2/tesseract-core.wasm.js','https://unpkg.com/tesseract.js-core@5.0.2/tesseract-core.wasm.js','https://cdnjs.cloudflare.com/ajax/libs/tesseract.js-core/5.0.2/tesseract-core.wasm.js'],
  lang:['https://github.com/naptha/tessdata/blob/gh-pages/4.0.0/eng.traineddata.gz?raw=true','https://tessdata.projectnaptha.com/4.0.0/eng.traineddata.gz']
};
async function headExists(url){ try{ var r=await fetch(url,{method:'GET',cache:'no-cache',mode:'cors'}); return r.ok; }catch(e){ return false; } }
async function seedOne(name, urls, localPath){
  for (var i=0;i<urls.length;i++){
    var u = urls[i];
    try{
      var r=await fetch(u,{cache:'no-store',mode:'cors'}); if(!r.ok) continue; var b=await r.blob();
      await caches.open('fo76-ocr').then(function(c){ return c.put(localPath,new Response(b)) });
      return URL.createObjectURL(b);
    }catch(e){}
  }
  throw new Error('Failed to download '+name);
}
async function ensureOCR(){
  var need=[];
  if(!(await headExists('./ocr/worker.min.js'))) need.push('worker');
  if(!(await headExists('./ocr/tesseract-core.wasm.js'))) need.push('core');
  if(!(await headExists('./ocr/eng.traineddata.gz'))) need.push('lang');
  var out={workerPath:'./ocr/worker.min.js', corePath:'./ocr/tesseract-core.wasm.js', langPath:'./ocr'};
  if(need.length===0) return out;
  document.getElementById('ocrStatus').textContent='Downloading one-time OCR files‚Ä¶';
  if(need.indexOf('worker')>=0){ document.getElementById('ocrStatus').textContent='Downloading OCR worker‚Ä¶'; out.workerPath=await seedOne('worker',OCR_MIRRORS.worker,'./ocr/worker.min.js'); }
  if(need.indexOf('core')>=0){ document.getElementById('ocrStatus').textContent='Downloading OCR core‚Ä¶'; out.corePath=await seedOne('core',OCR_MIRRORS.core,'./ocr/tesseract-core.wasm.js'); }
  if(need.indexOf('lang')>=0){ document.getElementById('ocrStatus').textContent='Downloading language data‚Ä¶'; out.langPath=(await seedOne('eng',OCR_MIRRORS.lang,'./ocr/eng.traineddata.gz')).replace(/eng\.traineddata\.gz$/,''); }
  document.getElementById('ocrStatus').textContent='Ready.'; return out;
}
function toast(msg){ var t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(function(){t.remove()}, 2600); }

/* ===== State helpers ===== */
var KEY="fo76-tracker-v1";
function load(){ try{var r=localStorage.getItem(KEY); return r?JSON.parse(r):{} }catch(e){ return {} } }
function save(s){ try{ localStorage.setItem(KEY, JSON.stringify(s)) }catch(e){} }
function newid(){ return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2); }
function fmt(t){ var ms=t-new Date(); if(ms<=0) return "Resetting‚Ä¶"; var s=Math.floor(ms/1e3), d=Math.floor(s/86400), h=Math.floor(s%86400/3600), m=Math.floor(s%3600/60); var parts=[]; if(d)parts.push(d+'d'); if(h||d)parts.push(h+'h'); if(m||h||d)parts.push(m+'m'); parts.push((s%60)+'s'); return parts.join(' '); }
function nextDaily(){ var e=new Date(); e.setHours(12,0,0,0); if(e<=new Date()) e.setDate(e.getDate()+1); return e }
function nextWeekly(){ var e=new Date(); e.setHours(12,0,0,0); var d=(2-e.getDay()+7)%7; if(d===0&&e<=new Date()) d=7; if(d>0) e.setDate(e.getDate()+d); if(e<=new Date()) e.setDate(e.getDate()+7); return e }
function looksCompleted(s){ var t=s.trim().toLowerCase(); if(/^(‚úî|‚úì|‚úÖ|!|‚òÖ)\s*/.test(t)) return true; if(/\s*(‚úî|‚úì|‚úÖ|!|‚òÖ)$/.test(t)) return true; if(/\b(completed?|claimed?|done|finished)\b/.test(t)) return true; if(/^(\||i)\s+/.test(t)||/\s+(\||i)$/.test(t)) return true; return false }
function parseLines(raw){ return raw.split(/\r?\n/).map(function(s){return s.replace(/[‚Ä¢¬∑‚ñ∫‚Üí]/g,' ').replace(/\s+/g,' ').trim()}).filter(Boolean); }
function guessChallenges(lines){ var out=[]; for(var i=0;i<lines.length;i++){ var s=lines[i]; var keep=/(complete|craft|kill|collect|build|scrap|discover|photo|event|workshop|legendary|ops|rank|score|nuke|daily|weekly)/i.test(s) || /\b\d{1,3}\b/.test(s); if(keep) out.push(s); } return out; }
function toItems(lines){ return lines.map(function(txt){ return { id:newid(), text: txt.replace(/^\s*(‚úî|‚úì|‚úÖ|!|\||i|‚òÖ)\s*/i,'').replace(/\s*(‚úî|‚úì|‚úÖ|!|\||i|‚òÖ)\s*$/i,'').trim(), done: looksCompleted(txt) }; }); }

/* ===== Review drawer ===== */
var review = (function(){
  var el = document.getElementById('reviewOverlay');
  var body = document.getElementById('reviewBody');
  var btnAll = document.getElementById('reviewSelectAll');
  var btnNone = document.getElementById('reviewSelectNone');
  var btnCopy = document.getElementById('reviewCopy');
  var btnDaily = document.getElementById('reviewImportDaily');
  var btnWeekly = document.getElementById('reviewImportWeekly');
  var btnClose = document.getElementById('reviewClose');
  var checkboxes = [];
  function show(lines, autoSelected, prefer){
    body.innerHTML=''; checkboxes = [];
    var ul=document.createElement('div');
    lines.forEach(function(line,i){
      var row=document.createElement('label'); row.style.display='flex'; row.style.gap='10px'; row.style.alignItems='center'; row.style.padding='6px 8px';
      var cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk chk--sm'; cb.checked = autoSelected.indexOf(i)>=0;
      var span=document.createElement('div'); span.textContent=line; span.style.flex='1';
      row.appendChild(cb); row.appendChild(span); ul.appendChild(row); checkboxes.push(cb);
    });
    body.appendChild(ul); el.classList.add('show');
    if(prefer==='daily') btnDaily.focus(); else if(prefer==='weekly') btnWeekly.focus();
  }
  function hide(){ el.classList.remove('show'); }
  btnAll.addEventListener('click',function(){checkboxes.forEach(function(c){c.checked=true})});
  btnNone.addEventListener('click',function(){checkboxes.forEach(function(c){c.checked=false})});
  btnCopy.addEventListener('click',function(){
    var text = Array.from(body.querySelectorAll('label div')).map(function(d){return d.textContent}).join('\n');
    if(navigator.clipboard) navigator.clipboard.writeText(text);
    toast('Copied OCR text');
  });
  btnClose.addEventListener('click', hide);
  return { show:show, hide:hide, selected:function(){ return checkboxes.map(function(c,i){return c.checked?i:-1}).filter(function(i){return i>=0}) } };
})();

/* ===== OCR overlay & pipeline ===== */
var overlay = (function(){
  var canceled=false;
  var el=document.getElementById('ocrOverlay');
  var status=document.getElementById('ocrStatus');
  var cancel=document.getElementById('ocrCancel');
  function onCancel(){ canceled=true; hide(); toast('Import canceled'); }
  cancel.addEventListener('click', onCancel);
  document.addEventListener('keydown', function(e){ if(e.key==='Escape' && el.classList.contains('show')) onCancel(); });
  return {
    show:function(msg){ canceled=false; status.textContent=msg||'Working‚Ä¶'; el.classList.add('show'); el.focus(); },
    msg:function(m){ if(!canceled) status.textContent=m },
    hide:function(){ el.classList.remove('show') },
    get canceled(){ return canceled; }
  };
})();

async function runOCR_pipeline(file){
  try{
    var o = await ensureOCR();
    if(overlay.canceled) return { raw:'', lines:[], guess:[] };
    overlay.msg('Reading (fast)‚Ä¶');
    var MAX=1440;
    function loadToCanvas(file){
      return new Promise(function(resolve,reject){
        var url=URL.createObjectURL(file); var img=new Image();
        img.onload=function(){
          var w=img.width,h=img.height; if(Math.max(w,h)>MAX){var s=MAX/Math.max(w,h); w=Math.round(w*s); h=Math.round(h*s);}
          var cv=document.createElement('canvas'); cv.width=w; cv.height=h; var cx=cv.getContext('2d'); cx.drawImage(img,0,0,w,h); URL.revokeObjectURL(url); resolve(cv);
        };
        img.onerror=reject; img.src=url;
      });
    }
    function canvasToBlob(cv){ return new Promise(function(res){ cv.toBlob(function(b){res(b)},'image/png',0.9) }) }
    var cv = await loadToCanvas(file);
    if(overlay.canceled) return { raw:'', lines:[], guess:[] };
    var blob = await canvasToBlob(cv);
    var timeout = new Promise(function(_,rej){ setTimeout(function(){rej(new Error('OCR timed out'))}, 35000) });
    // Fast
    var resFastP = Tesseract.recognize(blob, 'eng', {
      workerPath:o.workerPath, corePath:o.corePath, langPath:o.langPath,
      tessedit_pageseg_mode: 3,
      logger: function(m){ if(!overlay.canceled && m.status) overlay.msg(m.status+' '+Math.round((m.progress||0)*100)+'%') }
    }).then(function(r){ return (r&&r.data&&r.data.text)||'' });
    var rawFast = await Promise.race([resFastP, timeout]);
    var linesFast = parseLines(rawFast);
    var guessFast = guessChallenges(linesFast);
    if(guessFast.length >= 3) return { raw: rawFast, lines: linesFast, guess: guessFast };
    // Legacy
    overlay.msg('Reading (legacy)‚Ä¶');
    var resLegacyP = Tesseract.recognize(blob, 'eng', {
      workerPath:o.workerPath, corePath:o.corePath, langPath:o.langPath,
      tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 !?%+-()'",
      tessedit_pageseg_mode: 6,
      logger: function(m){ if(!overlay.canceled && m.status) overlay.msg(m.status+' '+Math.round((m.progress||0)*100)+'%') }
    }).then(function(r){ return (r&&r.data&&r.data.text)||'' });
    var rawLegacy = await Promise.race([resLegacyP, timeout]);
    var linesLegacy = parseLines(rawLegacy);
    var guessLegacy = guessChallenges(linesLegacy);
    return { raw: rawLegacy||rawFast, lines: linesLegacy.length?linesLegacy:linesFast, guess: guessLegacy.length?guessLegacy:guessFast };
  }catch(e){
    overlay.hide(); toast('OCR error'); return { raw:'', lines:[], guess:[] };
  }
}

/* ===== Currency mini cards ===== */
function GoldMini(){
  var st=load();
  var _set = React.useState(!!(st.gold||{}).dailyDone); var daily=_set[0], setDaily=_set[1];
  var _set2 = React.useState(!!(st.gold||{}).weeklyDone); var weekly=_set2[0], setWeekly=_set2[1];
  var d=React.useMemo(nextDaily,[]), w=React.useMemo(nextWeekly,[]);
  React.useEffect(function(){ var s=load(); s.gold={dailyDone:daily,weeklyDone:weekly}; save(s) },[daily,weekly]);
  React.useEffect(function(){ var i=setInterval(function(){ var n=new Date(); if(n>d&&daily)setDaily(false); if(n>w&&weekly)setWeekly(false)},15000); return function(){clearInterval(i)} },[daily,weekly,d,w]);
  var now=new Date(); var showD=d-now<=4*60*60*1000, showW=w-now<=24*60*60*1000;
  var badge=""; if(showD&&showW) badge="D "+fmt(d)+" ¬∑ W "+fmt(w); else if(showD) badge="Daily "+fmt(d); else if(showW) badge="Weekly "+fmt(w);
  return React.createElement('div',{className:'miniCard'},
    React.createElement('img',{src:'./arts/gold.svg',alt:'Gold'}),
    React.createElement('div',null, React.createElement('div',{style:{fontWeight:600}},'Gold'), badge?React.createElement('div',{className:'badge',style:{fontSize:12,color:'var(--muted)'}},badge):null),
    React.createElement('div',{className:'checks',style:{marginLeft:'8px'}},
      React.createElement('label',null, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:daily,onChange:function(e){setDaily(e.target.checked)}}),' Daily'),
      React.createElement('label',null, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:weekly,onChange:function(e){setWeekly(e.target.checked)}}),' Weekly')
    ));
}
function CapsMini(){
  var st=load();
  var _set = React.useState(!!(st.caps||{}).dailyDone); var caps=_set[0], setCaps=_set[1];
  var d=React.useMemo(nextDaily,[]);
  React.useEffect(function(){ var s=load(); s.caps={dailyDone:caps}; save(s) },[caps]);
  React.useEffect(function(){ var i=setInterval(function(){ if(new Date()>d&&caps)setCaps(false)},15000); return function(){clearInterval(i)} },[caps,d]);
  return React.createElement('div',{className:'miniCard'},
    React.createElement('img',{src:'./arts/cap.svg',alt:'Caps'}),
    React.createElement('div',null, React.createElement('div',{style:{fontWeight:600}},'Caps')),
    React.createElement('label',{style:{marginLeft:'8px'}}, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:caps,onChange:function(e){setCaps(e.target.checked)}}),' Daily')
  );
}

/* ===== Panels ===== */
function DailyPanel(props){
  if(!props.show) return null;
  var st=load();
  var def=[{id:newid(),text:"Complete a Daily Challenge",done:false},{id:newid(),text:"Kill 10 Creatures",done:false}];
  var _s = React.useState(st.daily||def); var items=_s[0], setItems=_s[1];
  var _t = React.useState(""); var txt=_t[0], setTxt=_t[1];
  var _h = React.useState(!!st.dailyHideDone); var hide=_h[0], setHide=_h[1];
  var d=React.useMemo(nextDaily,[]);
  React.useEffect(function(){ var s=load(); s.daily=items; s.dailyHideDone=hide; save(s) },[items,hide]);
  React.useEffect(function(){ var i=setInterval(function(){ if(new Date()>d) setItems(function(L){ return L.map(function(x){return {id:x.id,text:x.text,done:false}}) })},15000); return function(){clearInterval(i)} },[d]);
  function add(){ if(!txt.trim()) return; setItems(function(L){ return L.concat([{id:newid(),text:txt.trim(),done:false}]) }); setTxt("") }
  function toggle(i){ setItems(function(L){ return L.map(function(x){ return x.id===i?{id:x.id,text:x.text,done:!x.done}:x }) }) }
  function del(i){ setItems(function(L){ return L.filter(function(x){ return x.id!==i }) }) }
  function clearDone(){ setItems(function(L){ return L.filter(function(x){ return !x.done }) }) }
  async function importImage(ev){
    var f=ev.target.files && ev.target.files[0]; if(!f) return;
    overlay.show('Preparing OCR‚Ä¶');
    var out = await runOCR_pipeline(f);
    overlay.hide(); ev.target.value = "";
    var prefer='daily';
    var lines = out.lines && out.lines.length? out.lines : ['(No text detected)'];
    var guessed = out.guess? out.guess.map(function(g){return lines.indexOf(g)}).filter(function(i){return i>=0}) : [];
    review.show(lines, guessed, prefer);
    review._target = 'daily';
  }
  var shown = hide ? items.filter(function(x){return !x.done}) : items;
  return React.createElement('div',{className:'card'},
    React.createElement('div',{className:'head'},
      React.createElement('div',{className:'title'}, React.createElement('img',{src:'./arts/cap.svg',alt:'',style:{width:18,height:18}}), React.createElement('h3',null, "Daily Challenges")),
      React.createElement('div',{className:'right'},
        React.createElement('label',{className:'switch'}, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:hide,onChange:function(e){setHide(e.target.checked)}})," Hide completed")
      )
    ),
    React.createElement('div',{className:'body'},
      !props.compact && React.createElement('div',{className:'controls'},
        React.createElement('input',{className:'input',placeholder:'Add daily challenge‚Ä¶',value:txt,onChange:function(e){setTxt(e.target.value)}}),
        React.createElement('button',{className:'btn',onClick:add},'Add'),
        React.createElement('button',{className:'icon',onClick:clearDone,title:'Remove completed'},'‚úñ'),
        React.createElement('label',{className:'btn',style:{display:'inline-flex',alignItems:'center',gap:8,cursor:'pointer'}},
          React.createElement('input',{type:'file',accept:'image/*',onChange:importImage,style:{display:'none'}}),'Import image')
      ),
      React.createElement('div',{className:'list'},
        shown.map(function(it){
          return React.createElement('div',{key:it.id,className:'item '+(it.done?'done':''),onClick:function(){toggle(it.id)}},
            React.createElement('input',{className:'chk',type:'checkbox',checked:it.done,onChange:function(){toggle(it.id)}}),
            React.createElement('div',{className:'label'},it.text),
            !props.compact && React.createElement('button',{className:'icon',onClick:function(e){e.stopPropagation();del(it.id)}},'üóëÔ∏è')
          );
        }),
        shown.length===0 && React.createElement('div',{className:'progress'},'All clear.')
      )
    )
  );
}

function WeeklyPanel(props){
  if(!props.show) return null;
  var st=load();
  var def=[{id:newid(),text:"Complete 5 Daily Challenges",done:false},{id:newid(),text:"Complete 10 Events",done:false}];
  var _s = React.useState(st.weekly||def); var items=_s[0], setItems=_s[1];
  var _t = React.useState(""); var txt=_t[0], setTxt=_t[1];
  var _h = React.useState(!!st.weeklyHideDone); var hide=_h[0], setHide=_h[1];
  var w=React.useMemo(nextWeekly,[]);
  React.useEffect(function(){ var s=load(); s.weekly=items; s.weeklyHideDone=hide; save(s) },[items,hide]);
  React.useEffect(function(){ var i=setInterval(function(){ if(new Date()>w) setItems(function(L){ return L.map(function(x){return {id:x.id,text:x.text,done:false}}) })},15000); return function(){clearInterval(i)} },[w]);
  function add(){ if(!txt.trim()) return; setItems(function(L){ return L.concat([{id:newid(),text:txt.trim(),done:false}]) }); setTxt("") }
  function toggle(i){ setItems(function(L){ return L.map(function(x){ return x.id===i?{id:x.id,text:x.text,done:!x.done}:x }) }) }
  function del(i){ setItems(function(L){ return L.filter(function(x){ return x.id!==i }) }) }
  async function importImage(ev){
    var f=ev.target.files && ev.target.files[0]; if(!f) return;
    overlay.show('Preparing OCR‚Ä¶');
    var out = await runOCR_pipeline(f);
    overlay.hide(); ev.target.value = "";
    var prefer='weekly';
    var lines = out.lines && out.lines.length? out.lines : ['(No text detected)'];
    var guessed = out.guess? out.guess.map(function(g){return lines.indexOf(g)}).filter(function(i){return i>=0}) : [];
    review.show(lines, guessed, prefer);
    review._target = 'weekly';
  }
  var shown = hide ? items.filter(function(x){return !x.done}) : items;
  return React.createElement('div',{className:'card'},
    React.createElement('div',{className:'head'},
      React.createElement('div',{className:'title'}, React.createElement('img',{src:'./arts/gold.svg',alt:'',style:{width:18,height:18}}), React.createElement('h3',null, "Weekly Challenges")),
      React.createElement('div',{className:'right'},
        !props.compact && React.createElement('label',{className:'btn',style:{display:'inline-flex',alignItems:'center',gap:6,cursor:'pointer'}},
          React.createElement('input',{type:'file',accept:'image/*',onChange:importImage,style:{display:'none'}}),'Import image'),
        React.createElement('label',{className:'switch'}, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:hide,onChange:function(e){setHide(e.target.checked)}})," Hide completed")
      )
    ),
    React.createElement('div',{className:'body'},
      !props.compact && React.createElement('div',{className:'controls'},
        React.createElement('input',{className:'input',placeholder:'Add weekly challenge‚Ä¶',value:txt,onChange:function(e){setTxt(e.target.value)}}),
        React.createElement('button',{className:'btn',onClick:add},'Add'),
        React.createElement('button',{className:'icon',onClick:function(){ setItems(function(L){return L.filter(function(x){return !x.done}) }) },title:'Remove completed'},'‚úñ')
      ),
      React.createElement('div',{className:'list'},
        shown.map(function(it){
          return React.createElement('div',{key:it.id,className:'item '+(it.done?'done':''),onClick:function(){toggle(it.id)}},
            React.createElement('input',{className:'chk',type:'checkbox',checked:it.done,onChange:function(){toggle(it.id)}}),
            React.createElement('div',{className:'label'},it.text),
            !props.compact && React.createElement('button',{className:'icon',onClick:function(e){e.stopPropagation();del(it.id)}},'üóëÔ∏è')
          );
        })
      )
    )
  );
}

/* ===== Header + tabs ===== */
function Header(){
  return React.createElement('div',{className:'header'},
    React.createElement('div',{className:'header-left'},
      React.createElement('button',{className:'focusbtn',onClick:openTheme},'Theme'),
      React.createElement('button',{className:'focusbtn',onClick:function(){document.getElementById('infoOverlay').classList.add('show')}},'Info')
    ),
    React.createElement('div',{className:'header-right'},
      React.createElement('div',{className:'currency'},
        React.createElement(GoldMini,null),
        React.createElement(CapsMini,null)
      )
    )
  );
}
function FocusBar(props){
  var tabs=['All','Daily','Weekly'];
  return React.createElement('div',{className:'focusbar'},
    tabs.map(function(x){
      return React.createElement('button',{key:x,className:'focusbtn '+(props.focus===x?'active':''),onClick:function(){props.setFocus(x)}},x)
    })
  );
}
function App(){
  var st=load();
  var _f = React.useState(st.focus||"All"); var focus=_f[0], setFocus=_f[1];
  React.useEffect(function(){ var s=load(); s.focus=focus; save(s) },[focus]);
  React.useEffect(function(){
    var saved=localStorage.getItem('fo76-theme')||'green'; applyTheme(saved);
    drawWheel();
    document.getElementById('themeClose').addEventListener('click',function(){document.getElementById('themeOverlay').classList.remove('show')});
    document.getElementById('infoClose').addEventListener('click',function(){document.getElementById('infoOverlay').classList.remove('show')});
    setupInstallFromInfo();
    setupAutoUpdateUI(); setupAutoUpdate(); setupFooter();
  },[]);
  // storage "sync" ‚Üí simple reload when import commits via localStorage
  React.useEffect(function(){
    function onStorage(){ location.reload(); }
    window.addEventListener('storage', onStorage);
    return function(){ window.removeEventListener('storage', onStorage) };
  },[]);
  return React.createElement('div',{className:'container'},
    React.createElement(Header,null),
    React.createElement(FocusBar,{focus:focus,setFocus:setFocus}),
    React.createElement('div',{className:focus==='All'?'twocol':''},
      React.createElement(DailyPanel,{show:focus!=='Weekly', compact: focus==='All'}),
      React.createElement(WeeklyPanel,{show:focus!=='Daily', compact: focus==='All'})
    )
  );
}

/* ===== Mount & SW ===== */
var root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(React.StrictMode,null,React.createElement(App)));
if('serviceWorker' in navigator){ window.addEventListener('load',function(){navigator.serviceWorker.register('./sw-200.js')}); }

// Set version text
document.getElementById('verSlot').textContent = 'FO76 Tracker v' + VERSION;
</script>
</body>
</html>
