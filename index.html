<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#031207" />
<link rel="manifest" href="./manifest.webmanifest" />
<title>FO76 Tracker</title>
<link rel="stylesheet" href="./style-186.css" />
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Tesseract UMD loader -->
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<div id="root"></div>

<!-- OCR overlay -->
<div class="overlay" id="ocrOverlay">
  <div class="box">
    <h4>Importing…</h4>
    <p id="ocrStatus">Initializing…</p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button class="btn" id="ocrRetry" style="display:none">Try again</button>
      <button class="btn" id="ocrCancel">Cancel</button>
    </div>
    <p style="font-size:12px;margin-top:8px">Offline OCR: local files first, one-time download if missing.</p>
  </div>
</div>

<!-- Theme overlay (no labels) -->
<div class="overlay" id="themeOverlay">
  <div class="box" style="text-align:center;max-width:380px">
    <h4>Theme</h4>
    <svg id="wheel" viewBox="0 0 200 200" width="240" height="240" style="display:block;margin:0 auto">
      <defs><filter id="soft" x="-20%" y="-20%" width="140%"><feGaussianBlur in="SourceGraphic" stdDeviation="0.6"/></filter></defs>
      <circle cx="100" cy="100" r="96" fill="rgba(0,0,0,0.35)" stroke="var(--border)" stroke-width="2"></circle>
    </svg>
    <div class="theme-footer"><button class="btn" id="themeClose">Close</button></div>
  </div>
</div>

<!-- Info overlay (now defines OCR) -->
<div class="overlay" id="infoOverlay">
  <div class="box">
    <h3 style="margin:0 0 8px">FO76 Tracker — Quick guide</h3>
    <ul style="margin:8px 0 0 18px;line-height:1.5">
      <li><b>Theme</b>: pick any color slice.</li>
      <li><b>All / Daily / Weekly</b>: switch views; “All” shows both panels.</li>
      <li><b>Import image</b>: upload a screenshot; the app OCRs it and adds challenges.</li>
      <li><b>OCR</b> = <i>Optical Character Recognition</i> — turns text in your screenshot into editable text here.</li>
      <li><b>Hide completed</b>: hides checked items; auto-resets daily at noon ET, weekly on Tue noon ET.</li>
      <li><b>Gold</b>: two simple checkboxes; timers warn in the last 4h (Daily) and last 24h (Weekly).</li>
      <li><b>Caps</b>: daily checkbox for your cap routine; auto-resets at daily reset.</li>
      <li><b>Auto-update</b>: checks on load and every 30min; shows “Reload” when a new version is ready.</li>
    </ul>
    <div style="text-align:right;margin-top:12px"><button class="btn" id="infoClose">Close</button></div>
  </div>
</div>

<script>
/* ===== Theme system (no labels) ===== */
const THEMES = {
  green:{ color:'#4cff5a', tokens:{ '--bg':'#031207','--bg1':'#05160b','--bg2':'#072313','--panel':'rgba(3,18,9,.9)','--panel2':'#04150a','--border':'#0b3a1d','--text':'#c7ffb0','--muted':'#7acb79','--acc':'#4cff5a','--acc2':'#6dff84','--glow':'rgba(76,255,90,.25)' } },
  blue: { color:'#4cbcff', tokens:{ '--bg':'#07121f','--bg1':'#0c1a2e','--bg2':'#102541','--panel':'rgba(8,20,35,.9)','--panel2':'#0a1729','--border':'#113154','--text':'#c7e9ff','--muted':'#7ab1cb','--acc':'#4cbcff','--acc2':'#78d4ff','--glow':'rgba(76,188,255,.25)' } },
  red:  { color:'#ff4c4c', tokens:{ '--bg':'#1f0a0a','--bg1':'#2a0f0f','--bg2':'#3b1414','--panel':'rgba(35,8,8,.9)','--panel2':'#1f0d0d','--border':'#4a1b1b','--text':'#ffc7c7','--muted':'#cb7a7a','--acc':'#ff4c4c','--acc2':'#ff7a7a','--glow':'rgba(255,76,76,.25)' } },
  violet:{ color:'#b84cff', tokens:{ '--bg':'#130a1f','--bg1':'#1b0f2a','--bg2':'#27143b','--panel':'rgba(26,8,35,.9)','--panel2':'#1a0d29','--border':'#2d1b4a','--text':'#e1c7ff','--muted':'#b07acb','--acc':'#b84cff','--acc2':'#d178ff','--glow':'rgba(184,76,255,.25)' } },
  mono: { color:'#dfdfdf', tokens:{ '--bg':'#0d0d0d','--bg1':'#121212','--bg2':'#1a1a1a','--panel':'rgba(20,20,20,.9)','--panel2':'#141414','--border':'#2a2a2a','--text':'#dfdfdf','--muted':'#aaa','--acc':'#e0e0e0','--acc2':'#fff','--glow':'rgba(255,255,255,.18)' } },
  amber:{ color:'#ffb84c', tokens:{ '--bg':'#1b1205','--bg1':'#201606','--bg2':'#2a1d08','--panel':'rgba(34,22,8,.92)','--panel2':'#1c1307','--border':'#3a2a0e','--text':'#ffe9c2','--muted':'#d7b37a','--acc':'#ffb84c','--acc2':'#ffd78a','--glow':'rgba(255,184,76,.25)'} },
  teal: { color:'#39d3c6', tokens:{ '--bg':'#071c1a','--bg1':'#0a2321','--bg2':'#0e2f2c','--panel':'rgba(8,30,29,.9)','--panel2':'#0a2523','--border':'#114743','--text':'#c7fff7','--muted':'#7ad3cb','--acc':'#39d3c6','--acc2':'#7ff3e8','--glow':'rgba(57,211,198,.25)'} }
};
function applyTheme(name){ const t=THEMES[name]||THEMES.green; const r=document.documentElement; Object.entries(t.tokens).forEach(([k,v])=>r.style.setProperty(k,v)); localStorage.setItem('fo76-theme',name); }
function openTheme(){ document.getElementById('themeOverlay').classList.add('show') } function closeTheme(){ document.getElementById('themeOverlay').classList.remove('show') }
function drawWheel(){ const svg=document.getElementById('wheel'); Array.from(svg.querySelectorAll('path,circle.slice')).forEach(n=>n.remove());
  const keys=Object.keys(THEMES),cx=100,cy=100,r=90,stroke="rgba(0,0,0,0.0001)",step=(2*Math.PI)/keys.length;
  keys.forEach((k,i)=>{ const a0=-Math.PI/2+i*step, a1=-Math.PI/2+(i+1)*step+0.0001;
    const x0=cx+r*Math.cos(a0), y0=cy+r*Math.sin(a0), x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1), large=(a1-a0)>Math.PI?1:0;
    const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',`M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} Z`);
    p.setAttribute('fill',THEMES[k].color); p.setAttribute('stroke',stroke); p.setAttribute('stroke-width','1'); p.setAttribute('filter','url(#soft)'); p.style.cursor='pointer';
    p.addEventListener('click',()=>{applyTheme(k); closeTheme();}); svg.appendChild(p);
  });
  const cap=document.createElementNS('http://www.w3.org/2000/svg','circle'); cap.setAttribute('class','slice'); cap.setAttribute('cx',100); cap.setAttribute('cy',100); cap.setAttribute('r',24);
  cap.setAttribute('fill','var(--panel2)'); cap.setAttribute('stroke','var(--border)'); cap.setAttribute('stroke-width','2'); svg.appendChild(cap);
}

/* ===== Auto-update ===== */
function setupAutoUpdateUI() {
  const style = document.createElement('style');
  style.textContent = `.update-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;display:flex;gap:10px;align-items:center;z-index:9999;background:var(--panel);border:1px solid var(--border);box-shadow:var(--shadow);color:var(--text);padding:10px 14px;border-radius:12px}.update-toast button{border:1px solid var(--border);background:var(--panel2);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}`;
  document.head.appendChild(style);
}
function showUpdateToast(){
  if(document.querySelector('.update-toast')) return;
  const t=document.createElement('div'); t.className='update-toast'; t.innerHTML='<span>New version available</span>';
  const b=document.createElement('button'); b.textContent='Reload';
  b.onclick=async()=>{ const reg=await navigator.serviceWorker.getRegistration(); if(reg?.waiting) reg.waiting.postMessage('SKIP_WAITING'); else location.reload(); };
  t.appendChild(b); document.body.appendChild(t);
}
function setupAutoUpdate(){
  if(!('serviceWorker' in navigator)) return;
  let refreshing=false;
  navigator.serviceWorker.addEventListener('controllerchange',()=>{ if(refreshing) return; refreshing=true; window.location.reload(); });
  navigator.serviceWorker.getRegistration().then((reg)=>{
    if(!reg) return;
    reg.update();
    setInterval(()=>reg.update(), 30*60*1000);
    reg.addEventListener('updatefound',()=>{
      const sw=reg.installing; if(!sw) return;
      sw.addEventListener('statechange',()=>{ if(sw.state==='installed' && navigator.serviceWorker.controller) showUpdateToast(); });
    });
  });
}

/* ===== OCR seeding + simple recognize + timeout ===== */
const OCR_MIRRORS = {
  worker:['https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js','https://unpkg.com/tesseract.js@5/dist/worker.min.js','https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.3/worker.min.js'],
  core:['https://cdn.jsdelivr.net/npm/tesseract.js-core@5.0.2/tesseract-core.wasm.js','https://unpkg.com/tesseract.js-core@5.0.2/tesseract-core.wasm.js','https://cdnjs.cloudflare.com/ajax/libs/tesseract.js-core/5.0.2/tesseract-core.wasm.js'],
  lang:['https://github.com/naptha/tessdata/blob/gh-pages/4.0.0/eng.traineddata.gz?raw=true','https://tessdata.projectnaptha.com/4.0.0/eng.traineddata.gz']
};
async function headExists(url){ try{ const r=await fetch(url,{method:'GET',cache:'no-cache',mode:'cors'}); return r.ok; }catch{return false} }
async function seedOne(name, urls, localPath){
  for(const u of urls){
    try{ const r=await fetch(u,{cache:'no-store',mode:'cors'}); if(!r.ok) continue; const b=await r.blob();
      await caches.open('fo76-ocr').then(c=>c.put(localPath,new Response(b))); return URL.createObjectURL(b);
    }catch(e){}
  } throw new Error('Failed to download '+name);
}
async function ensureOCR(){
  const need=[];
  if(!(await headExists('./ocr/worker.min.js'))) need.push('worker');
  if(!(await headExists('./ocr/tesseract-core.wasm.js'))) need.push('core');
  if(!(await headExists('./ocr/eng.traineddata.gz'))) need.push('lang');
  const out={workerPath:'./ocr/worker.min.js', corePath:'./ocr/tesseract-core.wasm.js', langPath:'./ocr'};
  if(need.length===0) return out;
  document.getElementById('ocrStatus').textContent='Offline OCR files missing — downloading once…';
  if(need.includes('worker')){ document.getElementById('ocrStatus').textContent='Downloading OCR worker…'; out.workerPath=await seedOne('worker',OCR_MIRRORS.worker,'./ocr/worker.min.js'); }
  if(need.includes('core')){ document.getElementById('ocrStatus').textContent='Downloading OCR core…'; out.corePath=await seedOne('core',OCR_MIRRORS.core,'./ocr/tesseract-core.wasm.js'); }
  if(need.includes('lang')){ document.getElementById('ocrStatus').textContent='Downloading language data…'; out.langPath=(await seedOne('eng',OCR_MIRRORS.lang,'./ocr/eng.traineddata.gz')).replace(/eng\.traineddata\.gz$/,''); }
  document.getElementById('ocrStatus').textContent='Ready.'; return out;
}

const KEY="fo76-tracker-v1";
const load=()=>{try{const r=localStorage.getItem(KEY);return r?JSON.parse(r):{} }catch{return{}}}
const save=(s)=>{try{localStorage.setItem(KEY,JSON.stringify(s))}catch{}}
const newid=()=>Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{t.remove()}, 2600); }

function fmt(t){const ms=t-new Date();if(ms<=0)return"Resetting…";const s=Math.floor(ms/1e3),d=Math.floor(s/86400),h=Math.floor(s%86400/3600),m=Math.floor(s%3600/60);const parts=[];if(d)parts.push(`${d}d`);if(h||d)parts.push(`${h}h`);if(m||h||d)parts.push(`${m}m`);parts.push(`${s%60}s`);return parts.join(" ")}
function nextDaily(){const e=new Date();e.setHours(12,0,0,0);if(e<=new Date())e.setDate(e.getDate()+1);return e}
function nextWeekly(){const e=new Date();e.setHours(12,0,0,0);let d=(2-e.getDay()+7)%7;if(d===0&&e<=new Date())d=7;if(d>0)e.setDate(e.getDate()+d);if(e<=new Date())e.setDate(e.getDate()+7);return e}
function looksCompleted(s){const t=s.trim().toLowerCase();if(/^(✔|✓|✅|!|★)\s*/.test(t))return true;if(/\s*(✔|✓|✅|!|★)$/.test(t))return true;if(/\b(completed?|claimed?|done|finished)\b/.test(t))return true;if(/^(\||i)\s+/.test(t)||/\s+(\||i)$/.test(t))return true;return false}
function parseChallenges(raw, mode){
  const junk=[/^challenges?$/i,/^daily$/i,/^weekly$/i,/^monthly$/i,/^(complete|claim|track|view|back|exit|close)$/i,/^\d{1,2}:\d{2}(:\d{2})?$/, /^(expires|resets|time remaining)/i];
  const lines=raw.split(/\r?\n/).map(s=>s.replace(/[•·►→]/g,' ').replace(/\s+/g,' ').trim()).filter(Boolean).filter(s=>!junk.some(rx=>rx.test(s)));
  const looks=(s)=>/(complete|craft|kill|collect|build|scrap|discover|photo|event|workshop|legendary|daily ops|mutations?|nuke)/i.test(s)||/\b\d{1,3}\b/.test(s);
  let out=lines.filter(looks);
  if(mode==='weekly'){ out=out.filter(s=>/weekly|events?|daily challenges?|ops|legendary|pts|score/i.test(s)||/\b(10|25|50|100)\b/.test(s)); }
  const seen=new Set(), uniq=[];
  for(const s of out){ const k=s.toLowerCase().replace(/[^a-z0-9]+/g,' ').trim(); if(!seen.has(k)){ seen.add(k); uniq.push(s); } }
  return uniq.slice(0,50);
}

/* ===== UI bits ===== */
function GoldMini(){
  const st=load();
  const [daily,setDaily]=React.useState(!!(st.gold||{}).dailyDone);
  const [weekly,setWeekly]=React.useState(!!(st.gold||{}).weeklyDone);
  const d=React.useMemo(()=>nextDaily(),[]), w=React.useMemo(()=>nextWeekly(),[]);
  React.useEffect(()=>{const s=load(); s.gold={dailyDone:daily,weeklyDone:weekly}; save(s)},[daily,weekly]);
  React.useEffect(()=>{const i=setInterval(()=>{const n=new Date(); if(n>d&&daily)setDaily(false); if(n>w&&weekly)setWeekly(false)},15000);return()=>clearInterval(i)},[daily,weekly,d,w]);
  const now=new Date(); const showD=d-now<=4*60*60*1000, showW=w-now<=24*60*60*1000;
  let badge=""; if(showD&&showW) badge=`D ${fmt(d)} · W ${fmt(w)}`; else if(showD) badge=`Daily ${fmt(d)}`; else if(showW) badge=`Weekly ${fmt(w)}`;
  return React.createElement('div',{className:'gold'},
    React.createElement('div',null, React.createElement('h3',null,'Gold'), badge?React.createElement('div',{className:'badge'},badge):null),
    React.createElement('div',{className:'checks'},
      React.createElement('label',null, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:daily,onChange:e=>setDaily(e.target.checked)}),' Daily'),
      React.createElement('label',null, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:weekly,onChange:e=>setWeekly(e.target.checked)}),' Weekly')
    ));
}
function CapsMini(){
  const st=load();
  const [caps,setCaps]=React.useState(!!(st.caps||{}).dailyDone);
  const d=React.useMemo(()=>nextDaily(),[]);
  React.useEffect(()=>{const s=load(); s.caps={dailyDone:caps}; save(s)},[caps]);
  React.useEffect(()=>{const i=setInterval(()=>{if(new Date()>d&&caps)setCaps(false)},15000);return()=>clearInterval(i)},[caps,d]);
  return React.createElement('div',{className:'mini'},
    React.createElement('div',null, React.createElement('b',null,'Caps')),
    React.createElement('label',null, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:caps,onChange:e=>setCaps(e.target.checked)}),' Daily')
  );
}

function DailyPanel({show=true}){
  if(!show) return null;
  const st=load();
  const def=[{id:newid(),text:"Complete a Daily Challenge",done:false},{id:newid(),text:"Kill 10 Creatures",done:false}];
  const [items,setItems]=React.useState(st.daily||def);
  const [txt,setTxt]=React.useState(""); const [hide,setHide]=React.useState(!!st.dailyHideDone);
  const d=React.useMemo(()=>nextDaily(),[]);
  React.useEffect(()=>{const s=load(); s.daily=items; s.dailyHideDone=hide; save(s)},[items,hide]);
  React.useEffect(()=>{const i=setInterval(()=>{if(new Date()>d) setItems(L=>L.map(x=>({...x,done:false})))},15000);return()=>clearInterval(i)},[d]);
  function add(){ if(!txt.trim()) return; setItems(L=>[...L,{id:newid(),text:txt.trim(),done:false}]); setTxt("")}
  function toggle(i){ setItems(L=>L.map(x=>x.id===i?{...x,done:!x.done}:x))}
  function del(i){ setItems(L=>L.filter(x=>x.id!==i))}
  function clearDone(){ setItems(L=>L.filter(x=>!x.done))}
  function resetAll(){ setItems(L=>L.map(x=>({...x,done:false})))}
  async function importImage(ev){
    const f=ev.target.files?.[0]; if(!f) return;
    overlay.show('Preparing OCR…');
    const text = await runOCR_simple(f);
    overlay.hide(); ev.target.value = "";
    const adds = toItems(parseChallenges(text,'daily'));
    if (adds.length){ setItems(L => [...L, ...adds]); toast(`Imported ${adds.length} challenge${adds.length>1?'s':''}`); }
    else { toast('No challenge-like text found'); }
  }
  const shown = hide ? items.filter(x=>!x.done) : items;
  return React.createElement('div',{className:'card'},
    React.createElement('div',{className:'head'},
      React.createElement('h3',null, "Daily Challenges"),
      React.createElement('div',{className:'right'},
        React.createElement('label',{className:'switch'}, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:hide,onChange:e=>setHide(e.target.checked)})," Hide completed")
      )
    ),
    React.createElement('div',{className:'body'},
      React.createElement('div',{className:'controls'},
        React.createElement('input',{className:'input',placeholder:'Add daily challenge…',value:txt,onChange:e=>setTxt(e.target.value)}),
        React.createElement('button',{className:'btn',onClick:add},'Add'),
        React.createElement('button',{className:'icon',onClick:clearDone,title:'Remove completed'},'✖'),
        React.createElement('button',{className:'icon',onClick:resetAll,title:'Uncheck all'},'↺'),
        React.createElement('label',{className:'btn',style:{display:'inline-flex',alignItems:'center',gap:8,cursor:'pointer'}},
          React.createElement('input',{type:'file',accept:'image/*',onChange:importImage,style:{display:'none'}}),'Import image')
      ),
      React.createElement('div',{className:'list'},
        shown.map(it=>React.createElement('div',{key:it.id,className:'item '+(it.done?'done':''),onClick:()=>toggle(it.id)},
          React.createElement('input',{className:'chk',type:'checkbox',checked:it.done,onChange:()=>toggle(it.id)}),
          React.createElement('div',{className:'label'},it.text),
          React.createElement('button',{className:'icon',onClick:(e)=>{e.stopPropagation();del(it.id)}},'🗑️')
        )),
        shown.length===0 && React.createElement('div',{className:'progress'},'All clear.')
      )
    )
  );
}

function WeeklyPanel({show=true}){
  if(!show) return null;
  const st=load();
  const def=[{id:newid(),text:"Complete 5 Daily Challenges",done:false},{id:newid(),text:"Complete 10 Events",done:false}];
  const [items,setItems]=React.useState(st.weekly||def);
  const [txt,setTxt]=React.useState(""); const [hide,setHide]=React.useState(!!st.weeklyHideDone);
  const w=React.useMemo(()=>nextWeekly(),[]);
  React.useEffect(()=>{const s=load(); s.weekly=items; s.weeklyHideDone=hide; save(s)},[items,hide]);
  React.useEffect(()=>{const i=setInterval(()=>{if(new Date()>w) setItems(L=>L.map(x=>({...x,done:false})))},15000);return()=>clearInterval(i)},[w]);
  function add(){ if(!txt.trim()) return; setItems(L=>[...L,{id:newid(),text:txt.trim(),done:false}]); setTxt("")}
  function toggle(i){ setItems(L=>L.map(x=>x.id===i?{...x,done:!x.done}:x))}
  function del(i){ setItems(L=>L.filter(x=>x.id!==i))}
  async function importImage(ev){
    const f=ev.target.files?.[0]; if(!f) return;
    overlay.show('Preparing OCR…');
    const text = await runOCR_simple(f);
    overlay.hide(); ev.target.value = "";
    const adds = toItems(parseChallenges(text,'weekly'));
    if (adds.length){ setItems(L => [...L, ...adds]); toast(`Imported ${adds.length} challenge${adds.length>1?'s':''}`); }
    else { toast('No challenge-like text found'); }
  }
  const shown = hide ? items.filter(x=>!x.done) : items;
  return React.createElement('div',{className:'card'},
    React.createElement('div',{className:'head'},
      React.createElement('h3',null, "Weekly Challenges"),
      React.createElement('div',{className:'right'},
        React.createElement('label',{className:'btn',style:{display:'inline-flex',alignItems:'center',gap:6,cursor:'pointer'}},
          React.createElement('input',{type:'file',accept:'image/*',onChange:importImage,style:{display:'none'}}),'Import image'),
        React.createElement('label',{className:'switch'}, React.createElement('input',{className:'chk chk--sm',type:'checkbox',checked:hide,onChange:e=>setHide(e.target.checked)})," Hide completed")
      )
    ),
    React.createElement('div',{className:'body'},
      React.createElement('div',{className:'controls'},
        React.createElement('input',{className:'input',placeholder:'Add weekly challenge…',value:txt,onChange:e=>setTxt(e.target.value)}),
        React.createElement('button',{className:'btn',onClick:add},'Add')
      ),
      React.createElement('div',{className:'list'},
        shown.map(it=>React.createElement('div',{key:it.id,className:'item '+(it.done?'done':''),onClick:()=>toggle(it.id)},
          React.createElement('input',{className:'chk',type:'checkbox',checked:it.done,onChange:()=>toggle(it.id)}),
          React.createElement('div',{className:'label'},it.text),
          React.createElement('button',{className:'icon',onClick:(e)=>{e.stopPropagation();del(it.id)}},'🗑️')
        ))
      )
    )
  );
}

function Header(){
  return React.createElement('div',{className:'header'},
    React.createElement('div',{className:'header-left'},
      React.createElement('button',{className:'focusbtn',onClick:openTheme},'Theme'),
      React.createElement('button',{className:'focusbtn',onClick:()=>document.getElementById('infoOverlay').classList.add('show')},'Info')
    ),
    React.createElement('div',null),
    React.createElement('div',{className:'header-right'}, React.createElement(GoldMini,null) )
  );
}
function FocusBar({focus,setFocus}){
  return React.createElement('div',{className:'focusbar'},
    ['All','Daily','Weekly'].map(x=>React.createElement('button',{key:x,className:'focusbtn '+(focus===x?'active':''),onClick:()=>setFocus(x)},x))
  );
}
function App(){
  const st=load();
  const [focus,setFocus]=React.useState(st.focus||"All");
  React.useEffect(()=>{const s=load(); s.focus=focus; save(s)},[focus]);
  React.useEffect(()=>{
    const saved=localStorage.getItem('fo76-theme')||'green'; applyTheme(saved);
    drawWheel();
    document.getElementById('themeClose').addEventListener('click',()=>document.getElementById('themeOverlay').classList.remove('show'));
    document.getElementById('infoClose').addEventListener('click',()=>document.getElementById('infoOverlay').classList.remove('show'));
    setupAutoUpdateUI(); setupAutoUpdate();
  },[]);
  return React.createElement('div',{className:'container'},
    React.createElement(Header,null),
    React.createElement(FocusBar,{focus,setFocus}),
    React.createElement('div',{className:'secondarybar'}, React.createElement(CapsMini,null)),
    React.createElement('div',{className:focus==='All'?'twocol':''},
      React.createElement(DailyPanel,{show:focus!=='Weekly'}),
      React.createElement(WeeklyPanel,{show:focus!=='Daily'})
    )
  );
}

/* ===== OCR runner (simpler) ===== */
const overlay = {
  show:(msg)=>{const ov=document.getElementById('ocrOverlay'); const st=document.getElementById('ocrStatus'); st.textContent=msg||'Working…'; ov.classList.add('show');},
  msg:(m)=>document.getElementById('ocrStatus').textContent=m,
  hide:()=>document.getElementById('ocrOverlay').classList.remove('show')
};
async function runOCR_simple(file){
  try{
    const paths = await ensureOCR();
    overlay.msg('Loading OCR…');
    // scale image to a max side to keep things fast
    const MAX=1600;
    function loadToCanvas(file){
      return new Promise((resolve,reject)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>{
        let w=img.width,h=img.height; if(Math.max(w,h)>MAX){const s=MAX/Math.max(w,h); w=Math.round(w*s); h=Math.round(h*s);}
        const cv=document.createElement('canvas'); cv.width=w; cv.height=h; const cx=cv.getContext('2d'); cx.drawImage(img,0,0,w,h); URL.revokeObjectURL(url); resolve(cv); };
        img.onerror=reject; img.src=url; });
    }
    function canvasToBlob(cv){ return new Promise(res=>cv.toBlob(b=>res(b),'image/png',0.9)); }
    const cv = await loadToCanvas(file);
    const blob = await canvasToBlob(cv);

    // timeout guard
    const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error('OCR timed out')), 45000));

    const run = Tesseract.recognize(blob, 'eng', {
      workerPath: paths.workerPath,
      corePath: paths.corePath,
      langPath: paths.langPath,
      logger: m => { if (m.status) overlay.msg(`${m.status} ${Math.round((m.progress||0)*100)}%`) }
    });
    const res = await Promise.race([run, timeout]);
    return res.data?.text || "";
  }catch(e){
    console.error(e); overlay.msg('OCR error: '+(e.message||e)); return "";
  }
}

/* ===== Mount & SW ===== */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(React.StrictMode,null,React.createElement(App)));
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw-195.js')); }
</script>
</body>
</html>
