<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0d1a12" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="./manifest.webmanifest" />
<title>FO76 Tracker</title>
<link rel="stylesheet" href="./style-194.css" />
<!-- React (UMD) -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Tesseract -->
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<div id="root"></div>

<!-- OCR overlay -->
<div class="overlay" id="ocrOverlay">
  <div class="box">
    <h3>Importingâ€¦</h3>
    <p id="ocrStatus">Initializingâ€¦</p>
    <div class="row">
      <button class="btn" id="ocrCancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Review overlay -->
<div class="overlay" id="reviewOverlay">
  <div class="box">
    <h3>Review &amp; Import</h3>
    <div id="reviewSummary" class="muted" style="margin:6px 0 8px"></div>
    <div id="reviewBody" class="review-body"></div>
    <div class="row wrap" style="margin-top:10px">
      <button class="btn" id="reviewSelectAll">Select all</button>
      <button class="btn" id="reviewSelectNone">Select none</button>
      <button class="btn" id="reviewCopy">Copy text</button>
      <span class="flex1"></span>
      <button class="btn" id="reviewImportDaily">Import to Daily</button>
      <button class="btn" id="reviewImportWeekly">Import to Weekly</button>
      <button class="btn" id="reviewClose">Close</button>
    </div>
  </div>
</div>

<!-- Info / Settings overlay (scrollable, cleaner) -->
<div class="overlay" id="infoOverlay">
  <div class="box scroll">
    <h3>FO76 Tracker â€” Info</h3>

    <h4 class="section">Overview</h4>
    <ul class="info-list">
      <li><b>Reset:</b> Global reset at <b>12:00 UTC</b> (7 AM ET / 4 AM PT)</li>
      <li><b>OCR:</b> Reads challenge text from a screenshot. 
        <label class="btn" style="margin-left:8px;">
          <input type="checkbox" id="ocrAgg" class="chk sm"> Aggressive OCR
        </label>
      </li>
    </ul>

    <h4 class="section">Actions</h4>
    <div class="info-actions">
      <button class="btn" id="installBtn">Install</button>
      <button class="btn" id="refreshInInfo">âŸ³ Refresh</button>
      <button class="btn" id="resetDaily">Reset Dailies</button>
      <button class="btn" id="resetWeekly">Reset Weeklies</button>
      <button class="btn" id="exportData">Export</button>
      <button class="btn" id="importData">Import</button>
      <span class="flex1"></span>
      <span class="muted">Version: <span id="verInInfo"></span></span>
    </div>

    <h4 class="section">About</h4>
    <p class="muted" style="margin-top:6px">
      FO76 Tracker is an unofficial fan project for <b>Fallout 76</b>. It is not affiliated with, endorsed by, or supported by Bethesda Softworks or ZeniMax Media.
      &copy; Bethesda Softworks LLC. All Rights Reserved. Fallout and related marks are trademarks of ZeniMax Media Inc.
    </p>

    <div class="right"><button class="btn" id="infoClose">Close</button></div>
  </div>
</div>

<!-- Theme overlay (main screen control) -->
<div class="overlay" id="themeOverlay">
  <div class="box">
    <h3>Theme</h3>
    <p class="muted">Pick a color preset or tweak the accent. Changes save automatically.</p>
    <div class="wheel">
      <button class="swatch" data-preset="green"  title="Green"></button>
      <button class="swatch" data-preset="amber"  title="Amber"></button>
      <button class="swatch" data-preset="ice"    title="Ice Blue"></button>
      <button class="swatch" data-preset="white"  title="White"></button>
      <button class="swatch" data-preset="pink"   title="Pink"></button>
      <button class="swatch" data-preset="violet" title="Violet"></button>
    </div>
    <div class="wheel wheel-style">
      <label class="chip"><input type="radio" name="stylePreset" value="clean" checked> Clean</label>
      <label class="chip"><input type="radio" name="stylePreset" value="pipboy"> Pip-Boy Distortion</label>
    </div>
    <div class="row wrap" style="margin-top:8px">
      <label class="btn"> Accent <input type="color" id="themeColor" value="#b9ff7a" style="margin-left:8px"></label>
      <label class="btn"> Wear <input type="range" id="wearLevel" min="0" max="100" value="20" style="margin-left:8px"></label>
      <button class="btn" id="themeClose">Close</button>
    </div>
  </div>
</div>

<script>
/** v1.9.5 â€” warm palette, improved tabs, click-to-check, robust OCR + self-check **/

// ---------- Utilities ----------
function $(id){ return document.getElementById(id); }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k, def){ try{ const v=JSON.parse(localStorage.getItem(k)); return v??def }catch{ return def } }
function newid(){ return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2); }

// Next daily reset at 12:00 UTC
function nextDailyUTC(){
  const now = new Date();
  const nUTC = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 12,0,0,0);
  const reset = new Date(nUTC);
  if (now >= reset) reset.setUTCDate(reset.getUTCDate()+1);
  return reset;
}
// Next weekly reset at 12:00 UTC on TUESDAY (getUTCDay() === 2)
function nextWeeklyUTC(){
  const now = new Date();
  const base = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 12,0,0,0));
  let add = (2 - base.getUTCDay() + 7) % 7; // Tue = 2
  if (add===0 && now >= base) add = 7;
  base.setUTCDate(base.getUTCDate() + add);
  return base;
}
function msFmt(t){
  const ms = t - new Date(); if(ms<=0) return "Resettingâ€¦";
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400);
  const h = Math.floor((s%86400)/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  const parts=[]; if(d) parts.push(d+'d'); if(h||d) parts.push(h+'h'); if(m||h||d) parts.push(m+'m'); parts.push(sec+'s');
  return parts.join(' ');
}

// ---------- OCR helpers (hardened + self-check) ----------
const overlay = (() => {
  let canceled=false, term=null;
  const el = $('ocrOverlay'); const status=$('ocrStatus');
  function show(msg, t){ canceled=false; status.textContent=msg||'Workingâ€¦'; term=t||null; el.classList.add('show'); }
  function hide(){ el.classList.remove('show'); }
  function setTerminator(t){ term=t; }
  function cancel(){ canceled=true; try{ term && term(); }catch{} hide(); }
  $('ocrCancel').onclick = cancel;
  return { show, hide, setTerminator, cancel, get canceled(){return canceled;}, msg:(m)=>{ if(!canceled) status.textContent=m; } };
})();

const review = (() => {
  const el = $('reviewOverlay'); const body=$('reviewBody'); const sum=$('reviewSummary');
  $('reviewSelectAll').onclick = ()=> body.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=true);
  $('reviewSelectNone').onclick = ()=> body.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false);
  $('reviewCopy').onclick = async ()=> {
    const text=Array.from(body.querySelectorAll('label div')).map(d=>d.textContent).join('\\n');
    try{ await navigator.clipboard.writeText(text) }catch{}
  };
  $('reviewClose').onclick = ()=> el.classList.remove('show');
  function show(lines, autoIdx){
    body.innerHTML='';
    lines.forEach((line,i)=>{
      const row=document.createElement('label');
      row.className='review-row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk sm';
      cb.checked = autoIdx.includes(i);
      const txt=document.createElement('div'); txt.textContent=line; txt.className='flex1';
      row.appendChild(cb); row.appendChild(txt); body.appendChild(row);
    });
    sum.textContent = `Detected ${lines.length} line(s). Auto-selected ${autoIdx.length}. Review below, then import.`;
    el.classList.add('show');
  }
  function selectedLines(lines){
    const picks=[];
    body.querySelectorAll('.review-row').forEach((row,i)=>{
      const cb=row.querySelector('input[type=checkbox]');
      if(cb && cb.checked) picks.push(lines[i]);
    });
    return picks;
  }
  return { show, hide:()=>el.classList.remove('show'), selectedLines };
})();

function parseLines(raw){
  return raw.split(/\\r?\\n/).map(s=>s.replace(/[â€¢Â·â–ºâ†’]/g,' ').replace(/\\s+/g,' ').trim()).filter(Boolean);
}
function guessChallenges(lines){
  const rx=/(complete|craft|kill|collect|build|scrap|discover|photo|event|workshop|legendary|ops|rank|score|nuke|daily|weekly)/i;
  return lines.map((s,i)=> rx.test(s)||/\\b\\d{1,3}\\b/.test(s) ? i : -1).filter(i=>i>=0);
}
function looksDone(s){
  const t=s.trim().toLowerCase();
  return /^(âœ”|âœ“|âœ…|!|â˜…)\\s*/.test(t) || /\\s*(âœ”|âœ“|âœ…|!|â˜…)$/.test(t) || /\\b(completed?|claimed?|done|finished)\\b/.test(t);
}
function toItems(lines){
  return lines.map(txt=>({
    id: newid(),
    text: txt.replace(/^\\s*(âœ”|âœ“|âœ…|!|\\||i|â˜…)\\s*/i,'').replace(/\\s*(âœ”|âœ“|âœ…|!|\\||i|â˜…)\\s*$/i,'').trim(),
    done: looksDone(txt)
  }));
}
const OCR_MIRRORS = {
  worker:['https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js','https://unpkg.com/tesseract.js@5/dist/worker.min.js'],
  core:['https://cdn.jsdelivr.net/npm/tesseract.js-core@5.0.2/tesseract-core.wasm.js','https://unpkg.com/tesseract.js-core@5.0.2/tesseract-core.wasm.js'],
  lang:['https://tessdata.projectnaptha.com/4.0.0/eng.traineddata.gz','https://github.com/naptha/tessdata/blob/gh-pages/4.0.0/eng.traineddata.gz?raw=true']
};
async function ensureOCR(){
  const out={}; out.workerPath='./ocr/worker.min.js'; out.corePath='./ocr/tesseract-core.wasm.js'; out.langPath='./ocr';
  const isFile = location.protocol === 'file:';
  const ok = isFile ? [false,false,false] : await Promise.all([
    fetch(out.workerPath).then(r=>r.ok).catch(()=>false),
    fetch(out.corePath).then(r=>r.ok).catch(()=>false),
    fetch(out.langPath+'/eng.traineddata.gz').then(r=>r.ok).catch(()=>false),
  ]);
  if(ok.every(Boolean)) return out;
  overlay.msg('Downloading OCR filesâ€¦');
  async function pull(urls, localKey){
    for(const u of urls){
      try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) continue; const b=await r.blob(); return URL.createObjectURL(b); }catch{}
    }
    throw new Error('Failed '+localKey);
  }
  out.workerPath = await pull(OCR_MIRRORS.worker,'worker');
  out.corePath   = await pull(OCR_MIRRORS.core,'core');
  out.langPath   = (await pull(OCR_MIRRORS.lang,'lang')).replace(/eng\\.traineddata\\.gz$/,'');
  return out;
}
function prepCanvas(img, rotate){
  const MAX=1200;
  let w=img.width, h=img.height;
  if(rotate%180!==0){ [w,h]=[h,w]; }
  let s=1, mx=Math.max(w,h); if(mx>MAX) s=MAX/mx;
  const cv=document.createElement('canvas'); cv.width=Math.round(w*s); cv.height=Math.round(h*s);
  const cx=cv.getContext('2d');
  cx.save();
  if(rotate){
    cx.translate(cv.width/2, cv.height/2);
    cx.rotate(rotate*Math.PI/180);
    cx.drawImage(img, -img.height*s/2, -img.width*s/2, img.height*s, img.width*s);
  }else{
    cx.drawImage(img,0,0,cv.width,cv.height);
  }
  cx.restore();
  const id=cx.getImageData(0,0,cv.width,cv.height); const d=id.data;
  for(let i=0;i<d.length;i+=4){
    const y=(d[i]*0.299+d[i+1]*0.587+d[i+2]*0.114);
    const c=Math.min(255, Math.max(0,(y-128)*1.25+128));
    d[i]=d[i+1]=d[i+2]=c;
  }
  cx.putImageData(id,0,0);
  return cv;
}
async function recognize(file, o, aggressive){  // returns lines; guarantees resolve
  overlay.msg('Loading imageâ€¦');
  const url = URL.createObjectURL(file);
  const img = new Image();
  img.crossOrigin = 'anonymous';
  const loadP = new Promise((res, rej)=>{
    const t = setTimeout(()=>rej(new Error('Image load timeout')), 8000);
    img.onload = ()=>{ clearTimeout(t); res(); };
    img.onerror = (e)=>{ clearTimeout(t); rej(e); };
  });
  img.src = url;
  await loadP.catch(()=>{});
  URL.revokeObjectURL(url);
  if(!img.width || overlay.canceled) return [];

  const rotations = aggressive ? [0,90,180,270] : [0,90];
  const psms = aggressive ? [6,4,3] : [6,3];

  const deadline = Date.now() + 45000;
  const worker = await Tesseract.createWorker({
    workerPath:o.workerPath, corePath:o.corePath, langPath:o.langPath,
    logger: m=>{ if(m.status) overlay.msg(m.status+' '+Math.round((m.progress||0)*100)+'%'); }
  });
  overlay.setTerminator(async ()=>{ try{ await worker.terminate(); }catch{} });

  let best={text:'', score:0};
  try{
    await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
    for(const r of rotations){
      if (overlay.canceled || Date.now()>deadline) break;
      const cv=prepCanvas(img, r);
      for(const p of psms){
        if (overlay.canceled || Date.now()>deadline) break;
        overlay.msg(`Readingâ€¦ (rot ${r}Â°, psm ${p})`);
        await worker.setParameters({ tessedit_pageseg_mode: p });
        let timedOut=false; const passTimer=setTimeout(()=>{ timedOut=true; }, 20000);
        try{
          const res = await worker.recognize(cv);
          if(!timedOut){
            const txt=(res&&res.data&&res.data.text)||'';
            const lines=parseLines(txt);
            const score=lines.length;
            if(score>best.score) best={text:txt, score};
            if(score>=6){ clearTimeout(passTimer); break; }
          }
        }catch{}
        clearTimeout(passTimer);
      }
    }
  } finally {
    try{ await worker.terminate(); }catch{}
    overlay.setTerminator(null);
    overlay.hide();
  }
  return parseLines(best.text||'');
}

// ---------- Theme system (warmer presets) ----------
const PRESETS = {
  green: { acc:'#b9ff7a', text:'#e9ffdf', muted:'#b8f4b7', bg:'#0d1a12' },
  amber: { acc:'#ffd46a', text:'#fff3d6', muted:'#ffe2a4', bg:'#1a1406' },
  ice:   { acc:'#9fe9ff', text:'#e8fbff', muted:'#c9f3ff', bg:'#0b151b' },
  white: { acc:'#eaf6ff', text:'#ffffff', muted:'#cfdfea', bg:'#0b1116' },
  pink:  { acc:'#ffa2c8', text:'#ffe3f0', muted:'#ffc5df', bg:'#170d14' },
  violet:{ acc:'#c8a6ff', text:'#efe8ff', muted:'#d9c9ff', bg:'#120f1a' },
};
function applyTheme(palette, wear=20, style='clean'){
  const r = document.documentElement.style;
  const {acc,text,muted,bg} = palette;
  r.setProperty('--acc', acc);
  r.setProperty('--text', text);
  r.setProperty('--muted', muted);
  r.setProperty('--bg', bg);
  const blur = Math.round(wear/25)+1; // 1â€“5px
  const op = (wear/100)*.3;           // 0â€“0.3
  r.setProperty('--wearBlur', blur+'px');
  r.setProperty('--wearOpacity', op.toFixed(2));
  document.body.classList.toggle('crt', style==='pipboy' || wear>0);
}
const THEME_KEY='fo76-theme-v2';
const themeState = load(THEME_KEY, { preset:'green', wear:20, style:'clean', color:null });
function currentPalette(){ return themeState.color || PRESETS[themeState.preset] }
function saveTheme(){ save(THEME_KEY, themeState); }
applyTheme(currentPalette(), themeState.wear, themeState.style);

// ---------- App ----------
const KEY='fo76-tracker-v1';
const VERSION='1.9.5';

function Header(){
  return React.createElement('header',{className:'header'},
    React.createElement('div',{className:'left'},
      React.createElement('button',{className:'btn', onClick:()=>$('infoOverlay').classList.add('show')},'Info'),
      React.createElement('button',{className:'btn', onClick:()=>$('themeOverlay').classList.add('show')},'Theme')
    ),
    React.createElement('div',{className:'right'},
      React.createElement('div',{className:'mini'},
        React.createElement('div',null,
          React.createElement('div',{className:'title'},'Gold'),
          React.createElement('label',null, React.createElement('input',{type:'checkbox',className:'chk sm', id:'gold-d'}),' Daily'),
          React.createElement('label',{style:{marginLeft:6}}, React.createElement('input',{type:'checkbox',className:'chk sm', id:'gold-w'}),' Weekly')
        )
      ),
      React.createElement('div',{className:'mini'},
        React.createElement('div',null,
          React.createElement('div',{className:'title'},'Caps'),
          React.createElement('label',null, React.createElement('input',{type:'checkbox',className:'chk sm', id:'caps-d'}),' Daily')
        )
      )
    )
  );
}

function FocusBar(props){
  const tabs=['All','Daily','Weekly'];
  return React.createElement('div',{className:'focusbar'},
    tabs.map(t=>React.createElement('button',{
      key:t, className:'tab '+(props.focus===t?'active':''), onClick:()=>props.setFocus(t)
    },t))
  );
}

function ListPanel({kind, compact, showImport}){
  const state = load(KEY, {});
  const key = kind.toLowerCase();
  const defDaily = [{id:newid(), text:'Complete a Daily Challenge', done:false}];
  const defWeekly= [{id:newid(), text:'Complete 5 Daily Challenges', done:false}];

  const [items, setItems] = React.useState(state[key] || (key==='daily'?defDaily:defWeekly));
  const [txt, setTxt]     = React.useState('');
  const [hide, setHide]   = React.useState(!!state[key+'HideDone']);

  React.useEffect(()=>{
    const s=load(KEY,{}); s[key]=items; s[key+'HideDone']=hide; save(KEY,s);
  },[items,hide]);

  // Reset logic: tied to 12:00 UTC
  React.useEffect(()=>{
    const tick = setInterval(()=>{
      const n=new Date();
      const due = key==='daily' ? nextDailyUTC() : nextWeeklyUTC();
      if(n>due) setItems(l=>l.map(x=>({...x,done:false})));
    }, 15000);
    return ()=>clearInterval(tick);
  },[]);

  function add(){
    if(!txt.trim()) return;
    setItems(l=>l.concat([{id:newid(),text:txt.trim(),done:false}]));
    setTxt('');
  }
  function toggle(id){ setItems(l=>l.map(x=>x.id===id?({...x,done:!x.done}):x)); }
  function del(id){ setItems(l=>l.filter(x=>x.id!==id)); }

  async function importImage(ev){
    const f=ev.target.files && ev.target.files[0]; if(!f) return;
    const aggressive = !!load('fo76-agg', false);
    overlay.show('Preparing OCRâ€¦');
    try{
      const o = await ensureOCR();
      const lines = await recognize(f, o, aggressive); // always returns array
      if(!lines || !lines.length){ alert('No text recognized. Try a clearer screenshot or toggle Aggressive OCR.'); return; }
      const autoIdx=guessChallenges(lines);
      review.show(lines, autoIdx);

      $('reviewImportDaily').onclick = ()=>{
        const sel = review.selectedLines(lines);
        const s=load(KEY,{}); s.daily = (s.daily||[]).concat(toItems(sel)); save(KEY,s);
        alert(`Imported ${sel.length} item(s) to Daily`); review.hide();
      };
      $('reviewImportWeekly').onclick = ()=>{
        const sel = review.selectedLines(lines);
        const s=load(KEY,{}); s.weekly = (s.weekly||[]).concat(toItems(sel)); save(KEY,s);
        alert(`Imported ${sel.length} item(s) to Weekly`); review.hide();
      };
    }catch(e){
      alert('OCR failed. Try again.');
    } finally {
      overlay.hide();
      ev.target.value="";
    }
  }

  const due = key==='daily' ? nextDailyUTC() : nextWeeklyUTC();
  const now = new Date();
  const showWarn = key==='daily' ? (due-now <= 4*3600*1000) : (due-now <= 24*3600*1000);
  const shown = hide ? items.filter(x=>!x.done) : items;

  return React.createElement('div',{className:'card'},
    React.createElement('div',{className:'head'},
      React.createElement('div',{className:'title'}, kind+' Challenges'),
      React.createElement('div',{className:'right'},
        showImport && React.createElement('label',{className:'btn filebtn'},
          React.createElement('input',{type:'file',accept:'image/*',onChange:importImage,style:{display:'none'}}),
          'Import image'
        ),
        React.createElement('label',{className:'switch'}, React.createElement('input',{type:'checkbox',className:'chk sm',checked:hide,onChange:e=>setHide(e.target.checked)}),' Hide completed'),
        showWarn && React.createElement('span',{className:'badge'}, (key==='daily'?'Daily ':'Weekly ')+msFmt(due))
      )
    ),
    React.createElement('div',{className:'body'},
      !compact && React.createElement('div',{className:'controls'},
        React.createElement('input',{className:'input',placeholder:`Add ${key} challengeâ€¦`,value:txt,onChange:e=>setTxt(e.target.value)}),
        React.createElement('button',{className:'btn',onClick:add},'Add'),
        React.createElement('button',{className:'icon',onClick:()=>setItems(l=>l.filter(x=>!x.done))},'ðŸ—‘ï¸')
      ),
      React.createElement('div',{className:'list'},
        shown.map(it=>React.createElement('div',{key:it.id,className:'item '+(it.done?'done':''),onClick:()=>toggle(it.id)},
          React.createElement('input',{ type:'checkbox', className:'chk', checked:it.done, onClick:(e)=>e.stopPropagation(), readOnly:true }),
          React.createElement('div',{className:'label'},it.text),
          !compact && React.createElement('button',{className:'icon',onClick:(e)=>{e.stopPropagation();del(it.id)}},'ðŸ—‘ï¸')
        )),
        shown.length===0 && React.createElement('div',{className:'muted'},'All clear.')
      )
    )
  );
}

function App(){
  const st = load(KEY,{});
  const [focus,setFocus] = React.useState(st.focus || 'All');
  React.useEffect(()=>{ const s=load(KEY,{}); s.focus=focus; save(KEY,s); },[focus]);

  // Info
  $('infoClose').onclick = ()=>$('infoOverlay').classList.remove('show');
  $('refreshInInfo').onclick = async ()=>{ const reg = await navigator.serviceWorker.getRegistration(); if(reg){ await reg.update(); } location.href=location.pathname+'?r='+Date.now(); };
  $('verInInfo').textContent = 'v'+VERSION;

  // iOS/Android install prompt
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; });
  $('installBtn').onclick = ()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; } else { alert('Use your browser menu â†’ Install App'); } };

  // OCR aggressive toggle
  const AGG_KEY='fo76-agg';
  $('ocrAgg').checked = !!load(AGG_KEY, false);
  $('ocrAgg').onchange = (e)=> save(AGG_KEY, e.target.checked);

  // Theme overlay
  $('themeClose').onclick = ()=>$('themeOverlay').classList.remove('show');
  $('themeColor').value = (currentPalette().acc);
  $('wearLevel').value = themeState.wear;
  document.querySelectorAll('.swatch').forEach(btn=>{
    const preset = btn.dataset.preset;
    const p = PRESETS[preset] || PRESETS.green;
    btn.style.setProperty('--dot', p.acc);
    btn.onclick = ()=>{
      themeState.preset = preset;
      themeState.color = null;
      applyTheme(PRESETS[preset], themeState.wear, themeState.style);
      $('themeColor').value = PRESETS[preset].acc;
      saveTheme();
    };
  });
  $('themeColor').oninput = (e)=>{ const base = PRESETS[themeState.preset] || PRESETS.green; themeState.color = { ...base, acc: e.target.value }; applyTheme(themeState.color, themeState.wear, themeState.style); saveTheme(); };
  $('wearLevel').oninput = (e)=>{ themeState.wear = +e.target.value; applyTheme(currentPalette(), themeState.wear, themeState.style); saveTheme(); };
  document.querySelectorAll('input[name="stylePreset"]').forEach(r=>{ if(r.value === themeState.style) r.checked = true; r.onchange = ()=>{ if(r.checked){ themeState.style = r.value; applyTheme(currentPalette(), themeState.wear, themeState.style); saveTheme(); } }; });

  // Cancel overlays via Esc
  document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ overlay.cancel(); $('themeOverlay').classList.remove('show'); $('infoOverlay').classList.remove('show'); } });

  // Panels per tab
  return React.createElement('div',{className:'container'},
    React.createElement(Header,null),
    React.createElement(FocusBar,{focus,setFocus}),
    (function(){
      if(focus==='All'){
        return React.createElement('div',{className:'twocol'},
          React.createElement(ListPanel,{kind:'Daily',  compact:true,  showImport:false, key:'daily'}),
          React.createElement(ListPanel,{kind:'Weekly', compact:true,  showImport:false, key:'weekly'})
        );
      }else if(focus==='Daily'){
        return React.createElement(ListPanel,{kind:'Daily', compact:false, showImport:true, key:'daily'});
      }else{
        return React.createElement(ListPanel,{kind:'Weekly', compact:false, showImport:true, key:'weekly'});
      }
    })()
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(React.StrictMode,null,React.createElement(App)));

if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./sw-210.js'));
}
</script>
</body>
</html>
